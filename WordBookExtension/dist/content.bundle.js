(()=>{"use strict";const e={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var t,n=new Uint8Array(16);function o(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(n)}for(var r=[],a=0;a<256;++a)r.push((a+256).toString(16).slice(1));const s=function(t,n,a){if(e.randomUUID&&!n&&!t)return e.randomUUID();var s=(t=t||{}).random||(t.rng||o)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,n){a=a||0;for(var i=0;i<16;++i)n[a+i]=s[i];return n}return function(e,t=0){return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}(s)},i=["floatingButton","div_save","word_floating"];let d=null;function l(e,t){if(e.nodeType===Node.TEXT_NODE){let n=0,o=[],r=[],a=[];for(;;){console.log(e.textContent);let s=t.map((t=>e.textContent.indexOf(t.name,n)));if(s.every((e=>e<0)))break;let i=Array.from(s.keys());i.sort(((e,t)=>s[e]<0?1:s[t]<0?-1:s[e]-s[t]));let d=t[i[0]];a.push(i[0]),o.push(s[i[0]]),r.push(s[i[0]]+d.name.length),n=s[i[0]]+d.name.length}let s=e.parentNode;0!=a.length&&(a.forEach(((n,a)=>{let i=Object.assign(document.createElement("span"),{className:"highlight",textContent:t[n].name,onmouseenter:e=>{let o=document.getElementById("word_floating");o&&o.remove();let r=Object.assign(document.createElement("div"),{className:"t div_word",textContent:null,id:"word_floating",style:`position: absolute; top: ${e.pageY}px; left: ${e.pageX}px; z-index: 1000;`}),a=(Object.assign(document.createElement("div"),{className:"t div_wordName",textContent:t[n].name}),Object.assign(document.createElement("div"),{className:"t div_wordData",textContent:t[n].desc}));r.appendChild(a);let s=Object.assign(document.createElement("button"),{className:"t div_debugInfo",textContent:"debug info...",isClosed:!0});s.addEventListener("click",(function(){let e=s.isClosed;s.textContent=e?JSON.stringify(t[n]):"debug info...",s.isClosed=!e})),r.appendChild(s),document.body.appendChild(r)}}),d=e.textContent.slice(a<=0?0:r[a-1],o[a]),l=e.textContent.slice(r[a],a>=e.textContent.length-1?e.textContent.length-1:o[a+1]);s.insertBefore(document.createTextNode(d),e),s.insertBefore(i,e),s.insertBefore(document.createTextNode(l),e)})),s.removeChild(e))}else for(let n=0;n<e.childNodes.length;n++)"highlight"!==e.childNodes[n].className&&l(e.childNodes[n],t)}document.addEventListener("click",(function(e){let t=window.getSelection(),n=t.toString().trim();if(i.forEach((t=>{let n=document.getElementById(t);n&&!n.contains(e.target)&&n.remove()})),console.log(`select: ${n}`),n.length>0){console.log("button created.");let o=Object.assign(document.createElement("button"),{id:"floatingButton",textContent:"save",style:`position: absolute; top: ${e.pageY}px; left: ${e.pageX}px; z-index: 1000;`});o.addEventListener("mousedown",(function(){console.log("add new word");let r=Object.assign(document.createElement("div"),{id:"div_save",className:"t div_word",textContent:null,style:`position: absolute; top: ${e.pageY}px; left: ${e.pageX}px; z-index: 1000;`}),a=Object.assign(document.createElement("div"),{className:"t div_wordName",textContent:n});r.appendChild(a);let i=Object.assign(document.createElement("div"),{className:"t div_wordData"});r.appendChild(i),async function(){i.textContent="Generating response...";let e=function(e,t){if(0===e.rangeCount)return null;const n=e.getRangeAt(0),o=n.startContainer;if(o!==n.endContainer||o.nodeType!==Node.TEXT_NODE)return null;const r=n.startOffset,a=n.endOffset,s=o.textContent,i=Math.max(0,r-20),d=Math.min(s.length,a+20);return s.slice(i,d)}(t),o=`単語:${n} 文章:${e}`;try{i.textContent=await async function(e,t){let n="";console.log(`prompt: ${e}`);try{const o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"文章における単語の解説をしてください。解説は日本語で一文にして簡潔に述べてください。"},{role:"user",content:e}]})});n=(await o.json()).choices[0].message.content,console.log(`reply: ${n}`)}catch(e){console.error("Error:",e),n=e}return n}(o,d)}catch(e){i.textContent="Error generating response",console.error("Error:",e)}}();let l=Object.assign(document.createElement("button"),{className:"t",textContent:"add",style:"display: flex; justify-content: flex-end;"});l.addEventListener("click",(function(){let e="new";chrome.storage.local.get({wordList:[],categoryList:{}},(function(t){let o=t.wordList,r=t.categoryList,a={uuid:s(),name:n,desc:i.textContent,timestamp:(new Date).toISOString()};0==r.hasOwnProperty(e)&&(r[e]=[]),r[e].push(a.uuid),o.push(a),chrome.storage.local.set({wordList:o,categoryList:r},(function(){console.log(`Saved: ${JSON.stringify(a)} into ${e}.`)}))})),r.remove()})),r.appendChild(l),o.remove(),document.body.appendChild(r)})),document.body.appendChild(o)}})),window.onload=function(){chrome.storage.local.get({wordList:[],userProfile:{}},(function(e){l(document.body,e.wordList),d=e.userProfile.apiKey||""}))},chrome.runtime.onMessage.addListener(((e,t,n)=>{"yourLocalStorageKeyChanged"===e.message&&chrome.storage.local.get({wordList:[],userProfile:{}},(function(e){l(document.body,e.wordList),d=e.userProfile.apiKey||""}))}))})();